import streamlit as st
import asyncio
import logging
from datetime import datetime, timedelta
import pytz
from src.config.constants import UI_TEXTS, ROLE_REQUIREMENTS
from src.utils.session import SessionManager
from src.core.groq_agent import GroqAgent
from src.core.email_handler import EmailHandler
from src.utils.pdf_processor import PDFProcessor
from src.ui.components import UIComponents
from src.core.zoom_handler import CustomZoomTool
from dotenv import load_dotenv
import os
load_dotenv()
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class ApplicationManager:
    def __init__(self):
        self.session_manager = SessionManager()
        self.ui_components = UIComponents()
        self.pdf_processor = PDFProcessor()
        
    def initialize_agents(self):
        """API a√ßarlarƒ±nƒ±n yoxlanmasƒ± v…ô agent obyektl…ôrinin yaradƒ±lmasƒ±"""
        if not st.session_state['groq_api_key']:
            st.sidebar.error("Z…ôhm…ôt olmasa Groq API a√ßarƒ±nƒ± daxil edin!")
            return None, None

        try:
            groq_agent = GroqAgent(st.session_state['groq_api_key'])
            email_handler = EmailHandler()
            return groq_agent, email_handler
        except Exception as e:
            logger.error(f"Agent initialization error: {str(e)}")
            st.error("Agent obyektl…ôrinin yaradƒ±lmasƒ± zamanƒ± x…ôta!")
            return None, None

    def process_resume(self, resume_file, groq_agent):
        """CV faylƒ±nƒ±n emalƒ± v…ô t…ôhlili"""
        if not resume_file:
            return False

        st.subheader("Y√ºkl…ônmi≈ü CV")
        
        try:
            
            preview = self.pdf_processor.get_pdf_preview(resume_file)
            if preview:
                st.image(preview, caption="CV G√∂r√ºnt√ºs√º", use_column_width=True)
           
            resume_file.seek(0)

            if not st.session_state['resume_text']:
                with st.spinner("CV-niz emal olunur..."):
                    resume_text = self.pdf_processor.extract_text(resume_file)
                    if resume_text:
                        st.session_state['resume_text'] = resume_text
                        st.success("CV uƒüurla emal edildi!")

                        # email unvani cixar
                        email_from_resume = asyncio.run(groq_agent.extract_email(resume_text))
                        if email_from_resume:
                            st.session_state['candidate_email'] = email_from_resume
                            st.success(f"Email √ºnvanƒ± tapƒ±ldƒ±: {email_from_resume}")
                        else:
                            st.warning("CV-d…ôn email √ºnvanƒ± tapƒ±lmadƒ±.")
                        return True
                    else:
                        st.error("PDF emal edil…ô bilm…ôdi.")
                        return False

            return True

        except Exception as e:
            logger.error(f"Resume processing error: {str(e)}")
            st.error("CV emalƒ± zamanƒ± x…ôta ba≈ü verdi!")
            return False

    async def schedule_interview(self, role, email_handler):
        """M√ºsahib…ônin planla≈üdƒ±rƒ±lmasƒ±"""
        try:
            zoom_configs = {
                'account_id': st.session_state['zoom_account_id'],
                'client_id': st.session_state['zoom_client_id'],
                'client_secret': st.session_state['zoom_client_secret']
            }

            if not all(zoom_configs.values()):
                st.error("Zoom t…ônziml…ôm…ôl…ôrini tamamlayƒ±n!")
                return False

            baku_tz = pytz.timezone('Asia/Baku')
            current_time = datetime.now(baku_tz)
            next_workday = current_time + timedelta(days=1)
            
            if next_workday.weekday() >= 5:
                next_workday += timedelta(days=8 - next_workday.weekday())

            interview_time = next_workday.replace(hour=11, minute=0, second=0, microsecond=0)

            zoom_tool = CustomZoomTool(**zoom_configs)
            
            meeting_details = {
                "topic": f"{role} Texniki M√ºsahib…ô",
                "start_time": interview_time.strftime("%Y-%m-%dT%H:%M:%S"),
                "duration": 60,
                "timezone": "Asia/Baku"
            }

            meeting_response = await zoom_tool.create_meeting(meeting_details)
            
            if st.session_state.get('candidate_email'):
                await email_handler.send_interview_confirmation(
                    to_email=st.session_state['candidate_email'],
                    role=role,
                    meeting_details={
                        "date": interview_time.strftime("%Y-%m-%d"),
                        "time": interview_time.strftime("%H:%M"),
                        "join_url": meeting_response.get("join_url")
                    }
                )
                return True
            return False

        except Exception as e:
            logger.error(f"Interview scheduling error: {str(e)}")
            st.error("M√ºsahib…ô planla≈üdƒ±rƒ±lmasƒ± zamanƒ± x…ôta!")
            return False



def render_sidebar():
    """Render sidebar with configuration inputs"""
    with st.sidebar:
        st.header("T…ônziml…ôm…ôl…ôr")
        
        st.subheader("Groq API T…ônziml…ôm…ôl…ôri")
        api_key = st.text_input(
            "Groq API Key",
            value=st.session_state.get('groq_api_key', os.getenv("GROQ_API_KEY", "")),
            type="password"
        )
        st.session_state['groq_api_key'] = api_key
        
        st.subheader("Email T…ônziml…ôm…ôl…ôri")
        email_address = st.text_input(
            "Email Address",
            value=st.session_state.get('email_address', os.getenv("EMAIL_ADDRESS", "")),
            type="password"
        )
        st.session_state['email_address'] = email_address
        
        email_password = st.text_input(
            "Email Password",
            value=st.session_state.get('email_password', os.getenv("EMAIL_PASSWORD", "")),
            type="password"
        )
        st.session_state['email_password'] = email_password
        
        st.subheader("Zoom T…ônziml…ôm…ôl…ôri")
        account_id = st.text_input(
            "Zoom Account ID",
            value=st.session_state.get('zoom_account_id', os.getenv("ZOOM_ACCOUNT_ID", "")),
            type="password"
        )
        st.session_state['zoom_account_id'] = account_id
        
        client_id = st.text_input(
            "Zoom Client ID",
            value=st.session_state.get('zoom_client_id', os.getenv("ZOOM_CLIENT_ID", "")),
            type="password"
        )
        st.session_state['zoom_client_id'] = client_id
        
        client_secret = st.text_input(
            "Zoom Client Secret",
            value=st.session_state.get('zoom_client_secret', os.getenv("ZOOM_CLIENT_SECRET", "")),
            type="password"
        )
        st.session_state['zoom_client_secret'] = client_secret

def display_analysis_results(analysis_result):
    """T…ôhlil n…ôtic…ôl…ôrini g√∂st…ôrm…ôk √º√ß√ºn helper funksiya"""
    if not analysis_result:
        return
        
    col1, col2 = st.columns(2)
    with col1:
        st.metric("Uyƒüunluq", f"{analysis_result['uyƒüunluq_faizi']}%")
    with col2:
        st.metric("Q…ôrar", analysis_result['q…ôrar'].upper())

    with st.expander("∆ètraflƒ± T…ôhlil", expanded=True):
        st.write(analysis_result['t…ôhlil'])
        
        st.write("**G√ºcl√º t…ôr…ôfl…ôr:**")
        for strength in analysis_result['g√ºcl√º_t…ôr…ôfl…ôr']:
            st.write(f"- {strength}")
        
        st.write("**ƒ∞nki≈üaf t…ôl…ôb ed…ôn sah…ôl…ôr:**")
        for weakness in analysis_result['z…ôif_t…ôr…ôfl…ôr']:
            st.write(f"- {weakness}")
        
        st.write("**M…ôsl…ôh…ôtl…ôr:**")
        for suggestion in analysis_result['m…ôsl…ôh…ôtl…ôr']:
            st.write(f"- {suggestion}")

def main():
    try:
      
        SessionManager.init_session_state()
        
        st.title(UI_TEXTS["title"])
        
        render_sidebar()
        
        app = ApplicationManager()
        
        groq_agent, email_handler = app.initialize_agents()
        if not groq_agent or not email_handler:
            return

        role = st.selectbox(
            "M√ºraci…ôt etdiyiniz v…ôzif…ôni se√ßin:",
            list(ROLE_REQUIREMENTS.keys())
        )

        with st.expander("V…ôzif…ô t…ôl…ôbl…ôri", expanded=True):
            st.markdown(ROLE_REQUIREMENTS[role])

        if st.button("üìù Yeni M√ºraci…ôt"):
            SessionManager.reset_application()
            st.experimental_rerun()

        resume_file = st.file_uploader(
            "CV-nizi y√ºkl…ôyin (PDF)",
            type=["pdf"],
            key="resume_uploader"
        )

        if resume_file:
            app.process_resume(resume_file, groq_agent)

        email = st.text_input(
            "Namiz…ôdin email √ºnvanƒ±",
            value=st.session_state['candidate_email'],
            key="email_input"
        )
        st.session_state['candidate_email'] = email

        
        if st.session_state.get('analysis_result'):
            display_analysis_results(st.session_state['analysis_result'])

        # CV t…ôhlili
        if st.session_state['resume_text'] and email and not st.session_state['analysis_complete']:
            if st.button("CV-ni T…ôhlil Et"):
                with st.spinner("CV-niz t…ôhlil olunur..."):
                    try:
                        analysis_result = asyncio.run(groq_agent.analyze_resume(
                            st.session_state['resume_text'],
                            role
                        ))
                     
                       
                        st.session_state['analysis_result'] = analysis_result
                        
                        with st.expander("CV M…ôtni", expanded=False):
                            st.text_area(
                                "√áƒ±xarƒ±lmƒ±≈ü CV M…ôtni",
                                st.session_state['resume_text'],
                                height=300,
                                disabled=True
                            )

                        display_analysis_results(analysis_result)

                        is_selected = analysis_result.get("q…ôrar") == "q…ôbul"
                        
                        if is_selected:
                            st.success("T…ôbrikl…ôr! Sizin bacarƒ±qlarƒ±nƒ±z t…ôl…ôbl…ôr…ô uyƒüundur.")
                            st.session_state['analysis_complete'] = True
                            st.session_state['is_selected'] = True
                            st.experimental_rerun()
                        else:
                            st.warning("T…ô…ôss√ºf ki, sizin bacarƒ±qlarƒ±nƒ±z hal-hazƒ±rda t…ôl…ôbl…ôr…ô tam uyƒüun deyil.")
                            
                            with st.spinner("R…ôy emaili g√∂nd…ôrilir..."):
                                try:
                                    asyncio.run(email_handler.send_rejection_email(
                                        to_email=email,
                                        role=role,
                                        feedback=analysis_result['t…ôhlil'],
                                        suggestions=analysis_result.get("m…ôsl…ôh…ôtl…ôr", [])
                                    ))
                                    st.info("Siz…ô …ôtraflƒ± r…ôy emaili g√∂nd…ôrildi.")
                                except Exception as e:
                                    logger.error(f"Rejection email error: {str(e)}")
                                    st.error("Email g√∂nd…ôril…ô bilm…ôdi.")

                    except Exception as e:
                        logger.error(f"CV analysis error: {str(e)}")
                        st.error("CV t…ôhlili zamanƒ± x…ôta ba≈ü verdi!")

        if st.session_state['analysis_complete'] and st.session_state['is_selected']:
            st.success("T…ôbrikl…ôr! Sizin bacarƒ±qlarƒ±nƒ±z t…ôl…ôbl…ôr…ô uyƒüundur.")
            st.info("M√ºsahib…ô prosesin…ô ke√ßm…ôk √º√ß√ºn 'Davam Et' d√ºym…ôsini sƒ±xƒ±n.")

            if st.button("Davam Et", key="proceed_button"):
                col1, col2 = st.columns(2)
                
                with col1:
                    with st.spinner("üìß T…ôsdiq emaili g√∂nd…ôrilir..."):
                        try:
                            asyncio.run(email_handler.send_selection_email(
                                to_email=st.session_state['candidate_email'],
                                role=role
                            ))
                            st.success("‚úÖ T…ôsdiq emaili g√∂nd…ôrildi!")
                        except Exception as e:
                            st.error("‚ùå Email g√∂nd…ôrilm…ôsi x…ôtasƒ±!")
                            logger.error(f"Selection email error: {str(e)}")
                
                with col2:
                    with st.spinner("üìÖ M√ºsahib…ô planla≈üdƒ±rƒ±lƒ±r..."):
                        try:
                            if asyncio.run(app.schedule_interview(role, email_handler)):
                                st.success("‚úÖ M√ºsahib…ô planla≈üdƒ±rƒ±ldƒ±!")
                            else:
                                st.error("‚ùå M√ºsahib…ô planla≈üdƒ±rƒ±lmasƒ± x…ôtasƒ±!")
                        except Exception as e:
                            st.error("‚ùå M√ºsahib…ô planla≈üdƒ±rƒ±lmasƒ± x…ôtasƒ±!")
                            logger.error(f"Interview scheduling error: {str(e)}")

                st.success("""
                    üéâ M√ºraci…ôtiniz Uƒüurla Tamamlandƒ±!
                    
                    G√∂r√ºl…ôn i≈ül…ôr:
                    1. Se√ßim t…ôsdiqi ‚úÖ
                    2. M√ºsahib…ô planla≈üdƒ±rƒ±ldƒ± ‚úÖ
                    3. Zoom link g√∂nd…ôrildi ‚úÖ
                    
                    N√∂vb…ôti addƒ±mlar:
                    1. Email-inizi yoxlayƒ±n
                    2. M√ºsahib…ôy…ô 5 d…ôqiq…ô …ôvv…ôl qo≈üulun
                    3. Texniki m√ºsahib…ôy…ô hazƒ±rla≈üƒ±n
                """)

        if st.sidebar.button("M√ºraci…ôti Sƒ±fƒ±rla"):
            SessionManager.reset_application()
            st.experimental_rerun()

    except Exception as e:
        logger.error(f"Main application error: {str(e)}")
        st.error("Sistemd…ô x…ôta ba≈ü verdi. S…ôhif…ôni yenil…ôyin v…ô ya d…ôst…ôkl…ô …ôlaq…ô saxlayƒ±n.")

if __name__ == "__main__":
    main()